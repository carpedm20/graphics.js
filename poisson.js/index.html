<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <title>Poisson Disk Sampling</title>
</head>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>
var WIDTH = 960,
    HEIGHT = 500,
    MIN_DIST = 10,
    NEW_POINTS_COUNT = 3000;

function Point(x, y) {
  this.x = x || 0;
  this.y = y || 0;
}

function Points() {
  this.points = [];
  this.length = this.points.length;

  this.push = function(point) {
    this.points.push(point);

    this.length = this.points.length;
  };

  this.randomPop = function() {
    var length = this.points.length;
    var randIdx = parseInt(length * Math.random(), 10);

    var point = this.points.splice(randIdx, 1)[0];
    this.length = this.points.length;

    return point;
  };
}

function Grid(row, col) {
  this.points = new Array(row);

  for (var i=0; i<row; i++) {
    this.points[i] = new Array(col);
  }

  this.setPoint = function(row, col, point) {
    this.points[row][col] = point;
  };

  this.getPoint = function(row, col) {
    return this.points[row][col];
  };

  this.isExist = function(row, col) {
    if (this.points[row][col] === undefined)
      return false;
    else
      return true;
  };
}

function poissonDiskSampler(width, height, min_dist, new_points_count) {
  this.width = width || WDITH;
  this.height = height || HEIGHT;
  this.min_dist = min_dist || MIN_DIST;
  this.cell_size = min_dist/Math.sqrt(this.min_dist);
  this.new_points_count = new_points_count || NEW_POINTS_COUNT;

  this.samplePoints = new Points();
  this.processPoints = new Points();

  var row = parseInt(this.width/this.cell_size, 10)
  var col = parseInt(this.height/this.cell_size, 10)

  this.grid = new Grid(row, col);

  this.pointToGridPoint = function (point) {
    var row = parseInt(point.x / this.cell_size, 10);
    var col = parseInt(point.y / this.cell_size, 10);

    return new Point(row, col);
  };

  this.isInRange = function(point) {
    if (this.width < point.x || this.height < point.y)
      return false;
    else
      return true;
  };

  this.isThereAnyNeighbors = function(point) {
    var gridPoint = this.pointToGridPoint(point);
    var row = gridPoint.x;
    var col = gridPoint.y;

    var range = [-2, -1, 0, 1, 2];

    for (var i in range) {
      for (var j in range) {
        if (i === 0 || j === 0)
          continue;

        var pointToCompare = this.grid.getPoint(row, col);

        if (point === undefined)
          continue;
        else {
          var dist = Math.sqrt(Math.pow(point.x - pointToCompare.x, 2)
                      + Math.pow(point.y - pointToCompare.y, 2));
          if (dist < this.min_dist)
            return true;
        }
      }
    }

    return false;
  }

  this.generateRandomPointAround = function(centerPoint) {
    var length = this.min_dist * (1 + Math.random());
    var theta = 2 * Math.PI * Math.random();

    var x = centerPoint.x + this.min_dist * Math.sin(theta);
    var y = centerPoint.y + this.min_dist * Math.cos(theta);

    return new Point(x, y);
  }

  var x = width * Math.random();
  var y = height * Math.random();

  var startPoint = new Point(x, y);

  samplePoints.push(startPoint);
  processPoints.push(startPoint);

  var gridPoint = this.pointToGridPoint(startPoint);
  var row = gridPoint.x;
  var col = gridPoint.y;

  this.grid.setPoint(row, col, startPoint)

  while (processPoints.length > 0) {
    console.log("start loop");

    var tmpPoint = processPoints.randomPop();

    for (var i=0; i<new_points_count; i++) {
      var randomPoint = this.generateRandomPointAround(tmpPoint);

      if (this.isInRange(randomPoint)
           || this.isThereAnyNeigbors(randomPoint)) {
        processPoints.push(randomPoint);
        samplePoints.push(randomPoint);

        var gridPoint = this.pointToGridPoint(randomPoint);
        var row = gridPoint.x;
        var col = gridPoint.y;

        this.grid.setPoint(row, col, startPoint)
      }
    }
  }

  return this.samplePoints;
}

var sample = poissonDiskSampler(WIDTH, HEIGHT, MIN_DIST, NEW_POINTS_COUNT);

console.log(sample.length());
console.log(sample);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

</script>
